import { prisma } from "../src/lib/db";

async function clearAdminPasskey() {
  try {
    const email = "ikmls@hotmail.com";

    console.log("\nğŸ”„ Clearing passkeys for:", email);
    console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");

    // First, check current state
    const user = await prisma.users.findUnique({
      where: { email },
      include: {
        Authenticator: true,
      },
    });

    if (!user) {
      console.log("âŒ User not found!");
      return;
    }

    console.log("âœ… User found:");
    console.log("  â€¢ ID:", user.id);
    console.log("  â€¢ Email:", user.email);
    console.log("  â€¢ Role:", user.role);

    if (user.Authenticator.length === 0) {
      console.log("\nâš ï¸  No passkeys to clear - account is already clean!");
      console.log("\nğŸ’¡ You can go directly to registration:");
      console.log("  1. Go to your production app");
      console.log("  2. Navigate to registration page");
      console.log("  3. Register your passkey for", email);
      return;
    }

    console.log("\nğŸ”‘ Current passkeys:", user.Authenticator.length);
    user.Authenticator.forEach((auth, i) => {
      console.log(`\n  Passkey #${i + 1}:`);
      console.log("    â€¢ ID:", auth.id.substring(0, 30) + "...");
      console.log("    â€¢ Device:", auth.nickname || auth.deviceType);
      console.log("    â€¢ Created:", auth.createdAt);
      console.log("    â€¢ Last Used:", auth.lastUsedAt);
      console.log("    â€¢ Counter:", auth.counter);
    });

    console.log("\nâš ï¸  WARNING: About to delete all passkeys for this account!");
    console.log("After deletion, you will need to re-register your passkey.\n");

    // Delete all authenticators for this user
    const deleteResult = await prisma.authenticator.deleteMany({
      where: { userId: user.id },
    });

    console.log("âœ… Deleted", deleteResult.count, "passkey(s)");

    // Verify deletion
    const verifyUser = await prisma.users.findUnique({
      where: { email },
      include: {
        Authenticator: true,
      },
    });

    console.log("\nâœ… Verification: Account now has", verifyUser!.Authenticator.length, "passkeys");

    console.log("\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    console.log("\nğŸ¯ NEXT STEPS:\n");
    console.log("1. Make sure your production environment has correct WebAuthn config:");
    console.log("   â€¢ WEBAUTHN_RP_ID = your-domain.com (no https://)");
    console.log("   â€¢ WEBAUTHN_ORIGIN = https://your-domain.com (with https://)");
    console.log("");
    console.log("2. Redeploy your app if you changed environment variables");
    console.log("");
    console.log("3. Go to your production registration page");
    console.log("");
    console.log("4. Register a new passkey for:", email);
    console.log("");
    console.log("5. Try logging in with the new passkey");
    console.log("");
    console.log("ğŸ’¡ TIP: Check browser console during registration for any errors\n");
  } catch (error) {
    console.error("\nâŒ Error:", error);
  } finally {
    await prisma.$disconnect();
  }
}

// Safety check - require confirmation
const args = process.argv.slice(2);
const confirmed = args.includes("--confirm");

if (!confirmed) {
  console.log("\nâš ï¸  SAFETY CHECK REQUIRED\n");
  console.log("This script will DELETE all passkeys for ikmls@hotmail.com");
  console.log("");
  console.log("To proceed, run:");
  console.log("  npx tsx scripts/clear-admin-passkey.ts --confirm");
  console.log("");
  process.exit(0);
}

clearAdminPasskey();
