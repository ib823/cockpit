generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

model AuditEvent {
  id        String   @id
  userId    String
  type      String
  createdAt DateTime @default(now())
  meta      Json?
  users     users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, type, createdAt])
}

model SecurityEvent {
  id        String   @id
  type      String
  ipAddress String?
  userId    String?
  createdAt DateTime @default(now())
  meta      Json?

  @@index([type, createdAt])
  @@index([ipAddress])
}

model Authenticator {
  id         String   @id
  userId     String
  publicKey  Bytes
  counter    Int
  transports String[]
  deviceType String
  backedUp   Boolean
  nickname   String?
  createdAt  DateTime @default(now())
  lastUsedAt DateTime @default(now())
  users      users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model EmailApproval {
  email            String    @id
  tokenHash        String
  tokenExpiresAt   DateTime
  approvedByUserId String
  usedAt           DateTime?
  createdAt        DateTime  @default(now())
  codeSent         Boolean   @default(false)
}

model accounts {
  id                String  @id
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  users             users   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model audit_logs {
  id        String      @id
  userId    String
  action    AuditAction
  entity    String
  entityId  String
  changes   Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime    @default(now())
  users     users       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([entity, entityId])
  @@index([userId])
}

model chips {
  id         String   @id
  projectId  String
  createdAt  DateTime @default(now())
  confidence Decimal  @db.Decimal(3, 2)
  evidence   String?
  type       ChipType
  value      String
  projects   projects @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([type])
}

model comments {
  id        String   @id
  projectId String
  userId    String
  content   String
  resolved  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime
  projects  projects @relation(fields: [projectId], references: [id], onDelete: Cascade)
  users     users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([userId])
}

model form_items {
  id         String   @id
  projectId  String
  name       String
  type       String
  languages  String[]
  complexity String
  effort     Decimal  @db.Decimal(10, 2)
  createdAt  DateTime @default(now())
  projects   projects @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model holidays {
  id     String   @id
  name   String
  date   DateTime @db.Date
  region String

  @@unique([date, region])
  @@index([date])
  @@index([region])
}

model integration_items {
  id         String   @id
  projectId  String
  name       String
  type       String
  source     String
  target     String
  complexity String
  volume     String
  effort     Decimal  @db.Decimal(10, 2)
  createdAt  DateTime @default(now())
  projects   projects @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model magic_tokens {
  id         String    @id
  email      String
  token      String    @unique
  expiresAt  DateTime
  usedAt     DateTime?
  deviceInfo String?
  ipAddress  String?
  createdAt  DateTime  @default(now())
  type       String    @default("otp")

  @@index([email])
  @@index([token])
  @@index([type])
}

model phases {
  id               String      @id
  projectId        String
  name             String
  workingDays      Int
  color            String      @default("blue")
  order            Int
  createdAt        DateTime    @default(now())
  updatedAt        DateTime
  category         String
  dependencies     String?
  effort           Decimal     @db.Decimal(10, 2)
  startBusinessDay Int
  projects         projects    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  resources        resources[]

  @@index([order])
  @@index([projectId])
}

model projects {
  id                 String              @id
  name               String
  description        String?
  status             ProjectStatus       @default(DRAFT)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime
  clientName         String?
  complexity         String?
  duration           Int?
  employees          Int?
  endDate            DateTime?
  industry           String?
  integrationPosture String?
  legalEntities      Int?
  moduleCombo        String?
  ownerId            String
  rateRegion         String?
  region             String?
  revenue            Decimal?            @db.Decimal(15, 2)
  ssoMode            String?
  startDate          DateTime?
  totalCost          Decimal?            @db.Decimal(15, 2)
  totalEffort        Decimal?            @db.Decimal(10, 2)
  dashboardComments  DashboardComment[]
  dashboardExports   DashboardExport[]
  dashboardScenarios DashboardScenario[]
  dashboardSnapshots DashboardSnapshot[]
  chips              chips[]
  comments           comments[]
  form_items         form_items[]
  integration_items  integration_items[]
  phases             phases[]
  users              users               @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  resources          resources[]
  ricefw_items       ricefw_items[]
  shares             shares[]
  snapshots          snapshots[]

  @@index([createdAt])
  @@index([ownerId])
  @@index([status])
}

model push_subscriptions {
  id           String   @id
  email        String   @unique
  subscription Json
  createdAt    DateTime @default(now())
  updatedAt    DateTime

  @@index([email])
}

model resources {
  id         String   @id
  projectId  String
  phaseId    String?
  name       String
  role       String
  allocation Int
  createdAt  DateTime @default(now())
  hourlyRate Decimal  @db.Decimal(10, 2)
  region     String
  phases     phases?  @relation(fields: [phaseId], references: [id])
  projects   projects @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([phaseId])
  @@index([projectId])
}

model ricefw_items {
  id            String   @id
  projectId     String
  type          String
  name          String
  description   String?
  complexity    String
  count         Int
  effortPerItem Decimal  @db.Decimal(10, 2)
  totalEffort   Decimal  @db.Decimal(10, 2)
  phase         String
  createdAt     DateTime @default(now())
  updatedAt     DateTime
  projects      projects @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([projectId, type])
}

model sessions {
  id                String    @id
  sessionToken      String    @unique
  userId            String
  expires           DateTime
  deviceInfo        Json?
  ipAddress         String?
  lastActivity      DateTime  @default(now())
  deviceFingerprint String?
  userAgent         String?
  country           String?
  city              String?
  createdAt         DateTime  @default(now())
  revokedAt         DateTime?
  revokedReason     String?
  users             users     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([lastActivity])
  @@index([deviceFingerprint])
  @@index([revokedAt])
}

model shares {
  id           String    @id
  projectId    String
  token        String    @unique
  expiresAt    DateTime?
  viewCount    Int       @default(0)
  lastViewedAt DateTime?
  createdAt    DateTime  @default(now())
  projects     projects  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([token])
}

model snapshots {
  id        String   @id
  projectId String
  data      Json
  createdAt DateTime @default(now())
  createdBy String
  label     String?
  version   Int
  projects  projects @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, version])
  @@index([projectId])
}

model users {
  id                    String                      @id
  email                 String                      @unique
  name                  String?
  createdAt             DateTime                    @default(now())
  emailVerified         DateTime?
  image                 String?
  role                  Role                        @default(USER)
  updatedAt             DateTime
  accessExpiresAt       DateTime                    @default(now())
  exception             Boolean                     @default(false)
  firstLoginAt          DateTime?
  lastLoginAt           DateTime?
  lastTimelineAt        DateTime?
  timelinesGenerated    Int                         @default(0)
  lastSeenAt            DateTime?
  passwordHash          String?
  passwordChangedAt     DateTime?
  passwordExpiresAt     DateTime?
  passwordHistory       String[]
  totpSecret            String?
  totpEnabledAt         DateTime?
  maxConcurrentSessions Int                         @default(1)
  accountLockedAt       DateTime?
  accountLockedReason   String?
  failedLoginAttempts   Int                         @default(0)
  lastFailedLoginAt     DateTime?
  pendingEmail          String?
  pendingEmailToken     String?
  pendingEmailExpiresAt DateTime?
  recoveryRequests      AccountRecoveryRequest[]
  AuditEvent            AuditEvent[]
  Authenticator         Authenticator[]
  dashboardComments     DashboardComment[]
  dashboardExports      DashboardExport[]
  dashboardScenarios    DashboardScenario[]
  dashboardSettings     DashboardSettings?
  dashboardSnapshots    DashboardSnapshot[]
  ganttProjects         GanttProject[]              @relation("GanttProjectOwner")
  ganttProjectsModified GanttProject[]              @relation("GanttProjectLastModifier")
  ganttActiveSessions   GanttProjectActiveSession[] @relation("GanttActiveSessions")
  ganttCollaborations   GanttProjectCollaborator[]  @relation("GanttCollaborators")
  ganttInvitesCreated   GanttProjectCollaborator[]  @relation("GanttInviters")
  ganttInvites          GanttProjectInvite[]        @relation("GanttInviteCreators")
  loginHistory          LoginHistory[]
  recoveryCodes         RecoveryCode[]
  securityActions       SecurityAction[]
  trustedDevices        TrustedDevice[]
  accounts              accounts[]
  audit_logs            audit_logs[]
  comments              comments[]
  projects              projects[]
  sessions              sessions[]
  architectureProjects  ArchitectureProject[]       @relation("ArchitectureProjects")
  architectureCollabs   ArchitectureCollaborator[]  @relation("ArchitectureCollaborators")

  @@index([email])
  @@index([lastSeenAt])
  @@index([accountLockedAt])
  @@index([passwordExpiresAt])
}

model verification_tokens {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

/// Organization for multi-tenancy support
model Organization {
  id              String           @id @default(cuid())
  name            String
  settings        Json
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  rateCards       RateCard[]
  savedSelections SavedSelection[]
  scenarios       Scenario[]
  members         TeamMember[]

  @@index([name])
}

/// Team member with role-based access control
model TeamMember {
  id             String       @id @default(cuid())
  userId         String
  organizationId String
  role           UserRole     @default(VIEWER)
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([organizationId])
  @@index([userId])
}

/// Line of Business (12 LOBs)
model Lob {
  id                  String        @id @default(cuid())
  lobName             String        @unique
  l3Count             Int
  releaseTag          String
  navigatorSectionUrl String
  createdAt           DateTime      @default(now())
  l3ScopeItems        L3ScopeItem[]

  @@index([lobName])
}

/// L3 Scope Item (293 items from SAP Process Navigator)
model L3ScopeItem {
  id                  String              @id @default(cuid())
  lobId               String
  module              String?
  l3Code              String              @unique
  l3Name              String
  processNavigatorUrl String
  formerCode          String?
  releaseTag          String
  createdAt           DateTime            @default(now())
  complexityMetrics   ComplexityMetrics?
  integrationDetails  IntegrationDetails?
  lob                 Lob                 @relation(fields: [lobId], references: [id], onDelete: Cascade)

  @@index([lobId])
  @@index([l3Code])
  @@index([module])
}

/// Complexity metrics for each L3 item
model ComplexityMetrics {
  id                 String      @id @default(cuid())
  l3Id               String      @unique
  defaultTier        String
  coefficient        Float?
  tierRationale      String
  crossModuleTouches String?
  localizationFlag   Boolean     @default(false)
  extensionRisk      String
  createdAt          DateTime    @default(now())
  l3ScopeItem        L3ScopeItem @relation(fields: [l3Id], references: [id], onDelete: Cascade)

  @@index([defaultTier])
  @@index([extensionRisk])
}

/// Integration details for each L3 item
model IntegrationDetails {
  id                          String      @id @default(cuid())
  l3Id                        String      @unique
  integrationPackageAvailable String
  testScriptExists            Boolean     @default(true)
  createdAt                   DateTime    @default(now())
  l3ScopeItem                 L3ScopeItem @relation(fields: [l3Id], references: [id], onDelete: Cascade)
}

/// Saved L3 selection bundles for reuse
model SavedSelection {
  id             String       @id @default(cuid())
  name           String
  description    String?
  l3ItemIds      String[]
  organizationId String
  createdBy      String
  isPublic       Boolean      @default(false)
  usageCount     Int          @default(0)
  tags           String[]
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([createdBy])
  @@index([isPublic])
}

/// Rate card for resource costing
model RateCard {
  id             String       @id @default(cuid())
  organizationId String
  name           String
  country        String
  currency       String
  rates          Json
  effectiveFrom  DateTime
  effectiveTo    DateTime?
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, isActive])
  @@index([country])
}

/// Scenario (saved estimate with results)
model Scenario {
  id             String            @id @default(cuid())
  userId         String
  organizationId String?
  name           String
  inputs         Json
  totalMD        Float
  durationMonths Float
  pmoMD          Float
  phases         Json
  startDate      DateTime?
  resources      Json?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  organization   Organization?     @relation(fields: [organizationId], references: [id])
  versions       ScenarioVersion[]

  @@index([userId])
  @@index([organizationId])
  @@index([createdAt])
}

/// Scenario version history for audit trail
model ScenarioVersion {
  id            String   @id @default(cuid())
  scenarioId    String
  versionNumber Int
  label         String?
  snapshot      Json
  changes       Json?
  changeReason  String?
  createdBy     String
  createdAt     DateTime @default(now())
  scenario      Scenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)

  @@unique([scenarioId, versionNumber])
  @@index([scenarioId])
  @@index([createdAt])
}

/// Gantt Project - Main project container
/// Enhanced with version management for timeline changes
model GanttProject {
  id           String    @id @default(cuid())
  userId       String
  name         String
  description  String?
  startDate    DateTime  @db.Date
  viewSettings Json
  budget       Json?
  orgChart     Json?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  deletedAt    DateTime?

  // Optimistic locking & collaboration tracking
  version        Int       @default(1) // Incremental version number
  lastModifiedBy String?
  lastModifiedAt DateTime?

  // NEW: Version management for team capacity timeline changes
  isLatest        Boolean   @default(true) // Only one version should be latest
  parentVersionId String? // Links to previous version
  versionReason   String? // Why this version was created
  archivedAt      DateTime? // When this version was superseded

  // ARCHITECTURE DATA (Unified Project Model - Phase 1)
  // These fields enable viewing the same project as Timeline OR Architecture
  businessContext      Json? // BusinessContextData - entities, actors, capabilities
  currentLandscape     Json? // CurrentLandscapeData - AS-IS systems and integrations
  proposedSolution     Json? // ProposedSolutionData - TO-BE solution architecture
  diagramSettings      Json? // DiagramSettings - visual styling preferences
  architectureVersion  String? // Track architecture diagram version (e.g., "1.0", "2.3")
  lastArchitectureEdit DateTime? // When architecture data was last modified

  // Relations
  holidays           GanttHoliday[]
  milestones         GanttMilestone[]
  phases             GanttPhase[]
  user               users                       @relation("GanttProjectOwner", fields: [userId], references: [id], onDelete: Cascade)
  lastModifier       users?                      @relation("GanttProjectLastModifier", fields: [lastModifiedBy], references: [id], onDelete: SetNull)
  shares             GanttProjectShare[]
  collaborators      GanttProjectCollaborator[]
  invites            GanttProjectInvite[]
  resources          GanttResource[]
  activeSessions     GanttProjectActiveSession[]
  weeklyAllocations  ResourceWeeklyAllocation[] // NEW: Weekly allocation tracking
  costing            ProjectCosting? // NEW: Calculated costing snapshots (GSR, NSR, margins)
  costingConfig      ProjectCostingConfig? // NEW: Costing configuration (RR%, defaults)
  opeExpenses        OutOfPocketExpense[] // NEW: OPE breakdown
  subcontractorRates SubcontractorRate[] // NEW: Subcontractor-specific rates

  // Version lineage (self-referential)
  childVersions        GanttProject[]             @relation("ProjectVersions")
  parentVersion        GanttProject?              @relation("ProjectVersions", fields: [parentVersionId], references: [id], onDelete: SetNull)
  versionedAllocations ResourceWeeklyAllocation[] @relation("VersionedAllocations") // NEW: Allocations linked to this version

  @@index([userId])
  @@index([createdAt])
  @@index([updatedAt])
  @@index([deletedAt])
  @@index([version, isLatest]) // NEW: Composite index for version queries
  @@index([parentVersionId]) // NEW: Index for version lineage
  @@index([lastModifiedBy])
  @@index([lastArchitectureEdit])
}

/// Track active users currently viewing/editing a project
model GanttProjectActiveSession {
  id           String       @id @default(cuid())
  projectId    String
  userId       String
  lastSeenAt   DateTime     @default(now())
  isEditing    Boolean      @default(false)
  currentFocus String? // e.g., "task_123", "phase_456"
  project      GanttProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user         users        @relation("GanttActiveSessions", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
  @@index([lastSeenAt])
}

/// Gantt Phase - Major project phases
model GanttPhase {
  id                       String                         @id @default(cuid())
  projectId                String
  name                     String
  description              String?
  color                    String
  startDate                DateTime                       @db.Date
  endDate                  DateTime                       @db.Date
  collapsed                Boolean                        @default(false)
  order                    Int                            @default(0)
  dependencies             String[]
  project                  GanttProject                   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  phaseResourceAssignments GanttPhaseResourceAssignment[]
  tasks                    GanttTask[]

  @@index([projectId])
  @@index([order])
}

/// Gantt Task - Individual tasks within phases
model GanttTask {
  id                  String                        @id @default(cuid())
  phaseId             String
  name                String
  description         String?
  startDate           DateTime                      @db.Date
  endDate             DateTime                      @db.Date
  progress            Int                           @default(0)
  assignee            String?
  order               Int                           @default(0)
  dependencies        String[]
  collapsed           Boolean                       @default(false)
  isParent            Boolean                       @default(false)
  level               Int                           @default(0)
  parentTaskId        String?
  parentTask          GanttTask?                    @relation("TaskHierarchy", fields: [parentTaskId], references: [id], onDelete: Cascade)
  childTasks          GanttTask[]                   @relation("TaskHierarchy")
  phase               GanttPhase                    @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  resourceAssignments GanttTaskResourceAssignment[]

  @@index([phaseId])
  @@index([order])
  @@index([parentTaskId])
  @@index([level])
}

/// Gantt Milestone - Key project milestones
model GanttMilestone {
  id          String       @id @default(cuid())
  projectId   String
  name        String
  description String?
  date        DateTime     @db.Date
  icon        String
  color       String
  project     GanttProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([date])
}

/// Gantt Holiday - Project holidays/non-working days
model GanttHoliday {
  id        String       @id @default(cuid())
  projectId String
  name      String
  date      DateTime     @db.Date
  region    String
  type      String
  project   GanttProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([date])
}

/// Gantt Resource - Team members and their roles
/// Enhanced with validation, soft delete, and proper hierarchy constraints
model GanttResource {
  id          String @id @default(cuid())
  projectId   String
  name        String
  category    String
  description String
  designation String

  // Organization hierarchy - with self-referential FK constraint
  managerResourceId String?
  manager           GanttResource?  @relation("ResourceManager", fields: [managerResourceId], references: [id], onDelete: SetNull)
  directReports     GanttResource[] @relation("ResourceManager")

  // Contact info
  email       String?
  department  String?
  location    String?
  projectRole String?
  companyName String?

  // Assignment control
  assignmentLevel String @default("both") // "phase" | "task" | "both"

  // Billing & cost tracking
  isBillable        Boolean  @default(false)
  chargeRatePerHour Decimal? @db.Decimal(10, 2) // New: preferred field
  currency          String?  @default("MYR")
  utilizationTarget Int?
  regionCode        String? // NEW: Multi-region support (ABMY, ABSG, ABVN, ABTH, etc.)
  isSubcontractor   Boolean  @default(false) // NEW: Flag for subcontractor resources (different costing)

  // Deprecated billing fields (kept for backward compatibility during migration)
  rateType   String?
  hourlyRate Decimal? @db.Decimal(10, 2)
  dailyRate  Decimal? @db.Decimal(10, 2)

  // Data integrity & lifecycle
  isActive         Boolean   @default(true) // Soft delete flag
  validationStatus String    @default("valid") // "valid" | "orphaned" | "incomplete"
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @default(now()) @updatedAt
  deletedAt        DateTime? // Soft delete timestamp

  // Relations
  phaseAssignments   GanttPhaseResourceAssignment[]
  project            GanttProject                   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  taskAssignments    GanttTaskResourceAssignment[]
  weeklyAllocations  ResourceWeeklyAllocation[] // NEW: Weekly allocation tracking
  opeExpenses        OutOfPocketExpense[] // NEW: OPE tracking
  subcontractorRates SubcontractorRate[] // NEW: Subcontractor-specific rates (if isSubcontractor = true)

  @@index([projectId])
  @@index([category])
  @@index([designation]) // NEW: Index for rate lookups
  @@index([regionCode]) // NEW: Index for multi-region queries
  @@index([isSubcontractor]) // NEW: Index for subcontractor queries
  @@index([managerResourceId])
  @@index([isActive])
  @@index([validationStatus])
  @@index([createdAt])
}

/// Task Resource Assignment - Links resources to tasks
model GanttTaskResourceAssignment {
  id                   String        @id @default(cuid())
  taskId               String
  resourceId           String
  assignmentNotes      String
  allocationPercentage Int
  assignedAt           DateTime      @default(now())
  resource             GanttResource @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  task                 GanttTask     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([taskId, resourceId])
  @@index([taskId])
  @@index([resourceId])
}

/// Phase Resource Assignment - Links PM resources to phases
/// Enhanced with pattern-based allocation support
model GanttPhaseResourceAssignment {
  id                   String @id @default(cuid())
  phaseId              String
  resourceId           String
  assignmentNotes      String
  allocationPercentage Int // 0-100 baseline percentage

  // NEW: Pattern-based allocation support
  allocationPattern String? // "STEADY" | "CUSTOM" (null for legacy assignments)
  assignedBy        String? // User ID who created this assignment

  // Timestamps
  assignedAt DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  // Relations
  phase    GanttPhase    @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  resource GanttResource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@unique([phaseId, resourceId])
  @@index([phaseId])
  @@index([resourceId])
  @@index([assignedBy]) // NEW: Track who created assignments
  @@index([allocationPattern]) // NEW: Query by pattern type
}

/// Gantt Project Share - Share projects with view-only access (DEPRECATED - use GanttProjectInvite)
model GanttProjectShare {
  id           String       @id @default(cuid())
  projectId    String
  token        String       @unique
  expiresAt    DateTime?
  viewCount    Int          @default(0)
  lastViewedAt DateTime?
  createdAt    DateTime     @default(now())
  createdBy    String
  project      GanttProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([token])
}

/// Gantt Project Collaborator - Users who have access to a project
model GanttProjectCollaborator {
  id           String           @id @default(cuid())
  projectId    String
  userId       String
  role         CollaboratorRole @default(VIEWER)
  invitedBy    String
  invitedAt    DateTime         @default(now())
  acceptedAt   DateTime?
  lastAccessAt DateTime?
  project      GanttProject     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user         users            @relation("GanttCollaborators", fields: [userId], references: [id], onDelete: Cascade)
  inviter      users            @relation("GanttInviters", fields: [invitedBy], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
  @@index([invitedBy])
}

/// Gantt Project Invite - Pending invitations to collaborate on a project
model GanttProjectInvite {
  id         String           @id @default(cuid())
  projectId  String
  email      String
  token      String           @unique
  role       CollaboratorRole @default(VIEWER)
  expiresAt  DateTime?
  createdBy  String
  createdAt  DateTime         @default(now())
  acceptedAt DateTime?
  acceptedBy String?
  project    GanttProject     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  creator    users            @relation("GanttInviteCreators", fields: [createdBy], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([email])
  @@index([token])
  @@index([createdBy])
}

/// Trusted devices for device fingerprinting
model TrustedDevice {
  id          String   @id @default(cuid())
  userId      String
  fingerprint String
  lastSeenIp  String
  lastSeenAt  DateTime @default(now())
  nickname    String?
  userAgent   String
  country     String?
  city        String?
  createdAt   DateTime @default(now())
  user        users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, fingerprint])
  @@index([userId])
  @@index([fingerprint])
  @@index([lastSeenAt])
}

/// Login history with IP intelligence
model LoginHistory {
  id                String   @id @default(cuid())
  userId            String
  ipAddress         String
  country           String?
  city              String?
  region            String?
  timezone          String?
  deviceId          String?
  deviceFingerprint String?
  userAgent         String?
  success           Boolean
  failureReason     String?
  authMethod        String?
  timestamp         DateTime @default(now())
  user              users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([ipAddress])
  @@index([timestamp])
  @@index([success])
  @@index([deviceFingerprint])
}

/// Recovery codes for account recovery
model RecoveryCode {
  id        String    @id @default(cuid())
  userId    String
  codeHash  String
  usedAt    DateTime?
  usedFrom  String?
  createdAt DateTime  @default(now())
  user      users     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([usedAt])
}

/// Security actions (e.g., "Not me" button responses)
model SecurityAction {
  id        String    @id @default(cuid())
  userId    String
  action    String
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  ipAddress String?
  userAgent String?
  metadata  Json?
  createdAt DateTime  @default(now())
  user      users     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@index([usedAt])
}

/// Account recovery requests (admin-assisted)
model AccountRecoveryRequest {
  id              String    @id @default(cuid())
  userId          String
  reason          String
  status          String    @default("pending")
  submittedAt     DateTime  @default(now())
  approvedBy      String?
  approvedAt      DateTime?
  rejectedBy      String?
  rejectedAt      DateTime?
  rejectionReason String?
  notes           String?
  user            users     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([submittedAt])
}

/// Email delivery tracking
model EmailLog {
  id         String    @id @default(cuid())
  to         String
  subject    String
  template   String
  status     String    @default("pending")
  provider   String?
  error      String?
  metadata   Json?
  sentAt     DateTime?
  failedAt   DateTime?
  retryCount Int       @default(0)
  createdAt  DateTime  @default(now())

  @@index([to])
  @@index([status])
  @@index([template])
  @@index([createdAt])
}

/// Dashboard Snapshot - Stores saved dashboard states for later recall
model DashboardSnapshot {
  id            String   @id @default(cuid())
  projectId     String
  userId        String
  name          String
  description   String?
  costBreakdown Json
  margins       Json
  revenue       Decimal  @db.Decimal(12, 2)
  metrics       Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  isDefault     Boolean  @default(false)
  project       projects @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user          users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([projectId, userId])
  @@index([userId, createdAt])
}

/// Dashboard Scenario - For what-if analysis and scenario planning
model DashboardScenario {
  id          String   @id @default(cuid())
  projectId   String
  userId      String
  name        String
  description String?
  projectData Json
  revenue     Decimal  @db.Decimal(12, 2)
  assumptions Json?
  costDelta   Decimal? @db.Decimal(12, 2)
  marginDelta Decimal? @db.Decimal(6, 3)
  timeDelta   Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  isBaseline  Boolean  @default(false)
  project     projects @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user        users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([userId, projectId])
}

/// Dashboard Comment - Collaborative comments on dashboard elements
model DashboardComment {
  id          String             @id @default(cuid())
  projectId   String
  userId      String
  elementId   String?
  elementType String?
  content     String
  resolved    Boolean            @default(false)
  parentId    String?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  parent      DashboardComment?  @relation("CommentThread", fields: [parentId], references: [id], onDelete: Cascade)
  replies     DashboardComment[] @relation("CommentThread")
  project     projects           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user        users              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([projectId, elementId])
  @@index([userId, projectId])
  @@index([parentId])
}

/// Dashboard Settings - User-specific dashboard preferences
model DashboardSettings {
  id              String   @id @default(cuid())
  userId          String   @unique
  defaultView     String   @default("all")
  showChartTables Boolean  @default(false)
  autoRefresh     Boolean  @default(false)
  refreshInterval Int      @default(300000)
  customRateCard  Json?
  notifyOnChange  Boolean  @default(true)
  notifyOnComment Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

/// Dashboard Share - Share dashboard snapshots with others
model DashboardShare {
  id            String    @id @default(cuid())
  snapshotId    String
  sharedBy      String
  sharedWith    String?
  accessLevel   String    @default("view")
  expiresAt     DateTime?
  password      String?
  allowDownload Boolean   @default(true)
  viewCount     Int       @default(0)
  lastViewed    DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([snapshotId])
  @@index([sharedBy])
  @@index([sharedWith])
}

/// Dashboard Export History - Track dashboard exports for audit purposes
model DashboardExport {
  id           String    @id @default(cuid())
  projectId    String
  userId       String
  format       String
  filename     String
  fileSize     Int?
  status       String    @default("pending")
  errorMessage String?
  storageUrl   String?
  expiresAt    DateTime?
  createdAt    DateTime  @default(now())
  completedAt  DateTime?
  project      projects  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user         users     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([userId, createdAt])
  @@index([status])
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  SHARE
  EXPORT
  APPROVE
  ARCHIVE
}

enum ChipType {
  COUNTRY
  EMPLOYEES
  REVENUE
  INDUSTRY
  MODULES
  TIMELINE
  INTEGRATION
  COMPLIANCE
  LEGAL_ENTITIES
  SSO
  BANKING
  EXISTING_SYSTEM
  LOCATIONS
  USERS
  DATA_VOLUME
  CURRENCIES
  LANGUAGES
}

enum ProjectStatus {
  DRAFT
  IN_REVIEW
  APPROVED
  ARCHIVED
}

enum Role {
  USER
  MANAGER
  ADMIN
}

enum UserRole {
  ADMIN
  OWNER
  EDITOR
  VIEWER
}

// =============================================================================
// ARCHITECTURE V3 MODELS
// =============================================================================

model ArchitectureProject {
  id          String  @id @default(cuid())
  userId      String
  name        String
  description String?
  version     String  @default("1.0")

  // Architecture data stored as JSON for flexibility
  businessContext  Json // BusinessContextData
  currentLandscape Json // CurrentLandscapeData
  proposedSolution Json // ProposedSolutionData
  diagramSettings  Json // DiagramSettings

  // Metadata
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  lastEditedAt DateTime @default(now())
  lastEditedBy String?

  // Soft delete
  deletedAt DateTime?

  // Relations
  user          users                        @relation("ArchitectureProjects", fields: [userId], references: [id], onDelete: Cascade)
  versions      ArchitectureProjectVersion[]
  collaborators ArchitectureCollaborator[]

  @@index([userId])
  @@index([createdAt])
  @@index([updatedAt])
  @@index([deletedAt])
}

model ArchitectureProjectVersion {
  id            String  @id @default(cuid())
  projectId     String
  versionNumber Int
  name          String
  description   String?

  // Snapshot of data at this version
  businessContext  Json
  currentLandscape Json
  proposedSolution Json
  diagramSettings  Json

  // Metadata
  createdAt DateTime @default(now())
  createdBy String

  // Relations
  project ArchitectureProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, versionNumber])
  @@index([projectId])
  @@index([createdAt])
}

model ArchitectureCollaborator {
  id        String           @id @default(cuid())
  projectId String
  userId    String
  role      CollaboratorRole @default(VIEWER)

  // Metadata
  addedAt DateTime @default(now())
  addedBy String

  // Relations
  project ArchitectureProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    users               @relation("ArchitectureCollaborators", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
}

// =============================================================================
// TEAM CAPACITY & PROPOSAL ENGINE MODELS
// =============================================================================

/// Resource Weekly Allocation - Week-by-week resource allocation detail
/// CRITICAL for conflict detection and cross-project capacity planning
model ResourceWeeklyAllocation {
  id         String @id @default(cuid())
  projectId  String
  resourceId String

  // Week identification (ISO 8601 format: "2025-W03")
  weekIdentifier String // ISO week format for storage
  weekStartDate  DateTime @db.Date // Monday of the week
  weekEndDate    DateTime @db.Date // Sunday of the week

  // NEW: User-selectable week numbering system
  weekNumberingType WeekNumberingType @default(PROJECT_RELATIVE)
  weekNumber        Int? // Week number (meaning depends on weekNumberingType)

  // Allocation data (0-100% of resource capacity)
  allocationPercent Int     @db.SmallInt // 0-100 percentage
  workingDays       Decimal @db.Decimal(5, 2) // Calculated: allocationPercent * 5 / 100

  // NEW: Alternative mandays tracking (0.00 to 5.00 per week)
  mandays Decimal? @db.Decimal(4, 2) // For direct mandays entry

  // Source tracking (for pattern regeneration)
  sourcePhaseId    String? // Which phase this allocation belongs to
  sourcePattern    String? // "STEADY" | "CUSTOM"
  isManualOverride Boolean @default(false) // True if user manually edited

  // NEW: Version linkage (uses GanttProject's self-referential versioning)
  projectVersionId String? // Links to GanttProject version

  // Audit fields
  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime @updatedAt
  updatedBy String?

  // Relations
  project        GanttProject  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  resource       GanttResource @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  projectVersion GanttProject? @relation("VersionedAllocations", fields: [projectVersionId], references: [id], onDelete: SetNull)

  // Constraints & Indexes
  @@unique([projectId, resourceId, weekIdentifier]) // Prevent duplicate allocations
  @@index([resourceId, weekIdentifier]) // CRITICAL: Fast conflict detection across projects
  @@index([projectId, weekStartDate]) // Week-range queries for timeline views
  @@index([sourcePhaseId]) // Pattern regeneration when phase dates change
  @@index([createdAt]) // Audit queries
  @@index([weekNumberingType]) // NEW: Query by week numbering preference
  @@index([projectVersionId]) // NEW: Version-specific allocation queries
}

/// Resource Rate Lookup - Multi-region, multi-designation hourly rates
/// Supports forex conversion and effective date ranges
model ResourceRateLookup {
  id String @id @default(cuid())

  // Rate identification
  regionCode  String // "ABMY", "ABSG", "ABVN", "ABTH", etc.
  designation String // "Principal", "Director", "Manager", etc.

  // Rate data
  hourlyRate    Decimal @db.Decimal(10, 2) // In local currency
  localCurrency String // "MYR", "SGD", "VND", "THB"

  // Forex conversion to base currency (MYR)
  forexRate    Decimal @db.Decimal(10, 6) // Conversion rate to MYR
  baseCurrency String  @default("MYR")

  // Effective date range (for rate history)
  effectiveFrom DateTime  @db.Date
  effectiveTo   DateTime? @db.Date // null = current active rate

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  updatedBy String? // Admin user ID who set this rate

  // Constraints & Indexes
  @@unique([regionCode, designation, effectiveFrom]) // Prevent duplicate rates for same period
  @@index([regionCode, designation]) // Fast rate lookups
  @@index([effectiveFrom, effectiveTo]) // Date range queries for historical rates
  @@index([updatedAt]) // Audit trail
}

/// Project Costing - Calculated revenue, costs, and margin analysis
/// CONFIDENTIAL: Access restricted to Finance team via RBAC
model ProjectCosting {
  id        String @id @default(cuid())
  projectId String @unique // One-to-one with GanttProject

  // Revenue calculations
  grossServiceRevenue Decimal @db.Decimal(12, 2) // GSR = Total Std Rate × Days
  realizationRate     Decimal @db.Decimal(5, 4) // RR = e.g., 0.4300 (43%)
  commercialRate      Decimal @db.Decimal(12, 2) // Commercial = GSR × RR
  netServiceRevenue   Decimal @db.Decimal(12, 2) // NSR = Commercial × Days (actual billable)

  // Cost breakdown (MANUAL ENTRY - not auto-calculated for confidentiality)
  internalCost       Decimal @db.Decimal(12, 2) // ABeam resources (manual entry)
  subcontractorCost  Decimal @db.Decimal(12, 2) // External vendors (manual entry)
  outOfPocketExpense Decimal @db.Decimal(12, 2) // OPE - travel, onsite, etc.

  // Margin analysis
  totalCost        Decimal @db.Decimal(12, 2) // Internal + Subcon + OPE
  grossMargin      Decimal @db.Decimal(12, 2) // NSR - TotalCost
  marginPercentage Decimal @db.Decimal(5, 2) // (GrossMargin / NSR) × 100

  // Currency
  baseCurrency String @default("MYR")

  // Snapshot metadata
  calculatedAt DateTime @default(now())
  calculatedBy String? // User ID (must have Finance role)
  version      Int      @default(1) // Links to project version

  // Relations
  project GanttProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([projectId, version]) // Version-specific costing queries
  @@index([calculatedAt]) // Audit trail
  @@index([calculatedBy]) // Track who did costing
}

/// Out of Pocket Expense - Monthly breakdown of onsite costs
/// Tracks flights, hotel, parking, mileage per resource per month
model OutOfPocketExpense {
  id         String @id @default(cuid())
  projectId  String
  resourceId String

  // Time period (monthly aggregation)
  month DateTime @db.Date // First day of month (e.g., 2026-01-01)

  // OPE calculation inputs
  totalMandays     Decimal @db.Decimal(5, 2) // Total days worked this month
  onsitePercentage Decimal @db.Decimal(5, 2) // 0-100% of time spent onsite
  onsiteDays       Decimal @db.Decimal(5, 2) // totalMandays × onsitePercentage / 100

  // Cost components (from Excel Auto_OPE structure)
  flightCount     Int     @default(0) // Number of return trips
  flightRate      Decimal @db.Decimal(10, 2) // Cost per return trip
  totalFlightCost Decimal @db.Decimal(10, 2)

  hotelRate      Decimal @db.Decimal(10, 2) // Cost per night
  totalHotelCost Decimal @db.Decimal(10, 2) // hotelRate × onsiteDays

  parkingTollRate      Decimal @db.Decimal(10, 2) // Cost per day
  totalParkingTollCost Decimal @db.Decimal(10, 2) // parkingTollRate × onsiteDays

  mileageRate      Decimal @db.Decimal(10, 2) // Cost per km
  mileageKm        Decimal @db.Decimal(10, 2) // Total km traveled
  totalMileageCost Decimal @db.Decimal(10, 2) // mileageRate × mileageKm

  // Total OPE for this resource this month
  totalOPECost Decimal @db.Decimal(10, 2) // Sum of all components

  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  project  GanttProject  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  resource GanttResource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  // Constraints & Indexes
  @@unique([projectId, resourceId, month]) // One OPE entry per resource per month
  @@index([projectId, month]) // Monthly OPE reports
  @@index([resourceId]) // Per-resource OPE tracking
}

/// Project Costing Configuration - Stores CONFIGURATION parameters (not calculated values)
/// NOTE: ProjectCosting stores CALCULATED snapshots (GSR, NSR, margins)
/// This model stores the INPUT parameters (RR%, internal cost%, OPE defaults)
model ProjectCostingConfig {
  id        String @id @default(cuid())
  projectId String @unique

  // Realization Rate configuration
  realizationRatePercent Decimal @default(0.4300) @db.Decimal(5, 4) // 43% default from YTL Cement

  // Internal Cost Percentage (confidential - Finance only)
  internalCostPercent Decimal @default(0.3500) @db.Decimal(5, 4) // 35% of standard rate

  // OPE Defaults (per day rates in MYR)
  opeAccommodationPerDay Decimal @default(150.00) @db.Decimal(10, 2) // RM 150/night
  opeMealsPerDay         Decimal @default(50.00) @db.Decimal(10, 2) // RM 50/day
  opeTransportPerDay     Decimal @default(100.00) @db.Decimal(10, 2) // RM 100/day
  opeTotalDefaultPerDay  Decimal @default(500.00) @db.Decimal(10, 2) // RM 500/day

  // Intercompany Markup (when using cross-region resources)
  intercompanyMarkupPercent Decimal @default(1.1500) @db.Decimal(5, 4) // 15% markup

  // Currency
  baseCurrency String @default("MYR")

  // Security - controls who can view cost data
  costVisibilityLevel CostVisibilityLevel @default(FINANCE_ONLY)

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  // Relations
  project GanttProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

/// Subcontractor Rate - Project-specific rates for external vendors
/// Finance team only - can have negative margins (cost > revenue)
model SubcontractorRate {
  id         String @id @default(cuid())
  projectId  String
  resourceId String

  subcontractorCompany String // e.g., "ABC Consulting Sdn Bhd"

  dailyCommercialRate Decimal @db.Decimal(10, 2) // What client pays (revenue)
  dailyCostRate       Decimal @db.Decimal(10, 2) // What company pays subcon (cost)

  currency String @default("MYR")

  notes String? // Contract details, PO number, etc.

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String // Finance user only

  // Relations
  project  GanttProject  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  resource GanttResource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@unique([projectId, resourceId])
  @@index([projectId])
  @@index([resourceId])
}

// =============================================================================
// END OF TEAM CAPACITY MODELS
// =============================================================================

// =============================================================================
// TEAM CAPACITY MODULE ENUMS
// =============================================================================

/// Week numbering system (user-selectable preference)
enum WeekNumberingType {
  PROJECT_RELATIVE // Week 1, 2, 3... from project start
  ISO_WEEK // ISO 8601 (W01-W53)
  CALENDAR_WEEK // Sequential from Jan 1
}

/// Cost visibility levels (three-tier security model)
enum CostVisibilityLevel {
  PUBLIC // All users see cost data (NOT RECOMMENDED)
  PRESALES_AND_FINANCE // Presales sees NSR, Finance sees margins
  FINANCE_ONLY // Only Finance team (RECOMMENDED DEFAULT)
}

enum CollaboratorRole {
  OWNER
  EDITOR
  VIEWER
}
