generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x", "rhel-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

model AuditEvent {
  id        String   @id
  userId    String
  type      String
  createdAt DateTime @default(now())
  meta      Json?
  users     users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, type, createdAt])
}

model SecurityEvent {
  id        String   @id
  type      String
  ipAddress String?
  userId    String?
  createdAt DateTime @default(now())
  meta      Json?

  @@index([type, createdAt])
  @@index([ipAddress])
}

model Authenticator {
  id         String   @id
  userId     String
  publicKey  Bytes
  counter    Int
  transports String[]
  deviceType String
  backedUp   Boolean
  nickname   String?
  createdAt  DateTime @default(now())
  lastUsedAt DateTime @default(now())
  users      users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model EmailApproval {
  email            String    @id
  tokenHash        String
  tokenExpiresAt   DateTime
  approvedByUserId String
  usedAt           DateTime?
  createdAt        DateTime  @default(now())
  codeSent         Boolean   @default(false)
}

model accounts {
  id                String  @id
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  users             users   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model audit_logs {
  id        String      @id
  userId    String
  action    AuditAction
  entity    String
  entityId  String
  changes   Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime    @default(now())
  users     users       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([entity, entityId])
  @@index([userId])
}

model chips {
  id         String   @id
  projectId  String
  createdAt  DateTime @default(now())
  confidence Decimal  @db.Decimal(3, 2)
  evidence   String?
  type       ChipType
  value      String
  projects   projects @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([type])
}

model comments {
  id        String   @id
  projectId String
  userId    String
  content   String
  resolved  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime
  projects  projects @relation(fields: [projectId], references: [id], onDelete: Cascade)
  users     users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([userId])
}

model form_items {
  id         String   @id
  projectId  String
  name       String
  type       String
  languages  String[]
  complexity String
  effort     Decimal  @db.Decimal(10, 2)
  createdAt  DateTime @default(now())
  projects   projects @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model holidays {
  id     String   @id
  name   String
  date   DateTime @db.Date
  region String

  @@unique([date, region])
  @@index([date])
  @@index([region])
}

model integration_items {
  id         String   @id
  projectId  String
  name       String
  type       String
  source     String
  target     String
  complexity String
  volume     String
  effort     Decimal  @db.Decimal(10, 2)
  createdAt  DateTime @default(now())
  projects   projects @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model magic_tokens {
  id         String    @id
  email      String
  token      String    @unique
  expiresAt  DateTime
  usedAt     DateTime?
  deviceInfo String?
  ipAddress  String?
  createdAt  DateTime  @default(now())
  type       String    @default("otp")

  @@index([email])
  @@index([token])
  @@index([type])
}

model phases {
  id               String      @id
  projectId        String
  name             String
  workingDays      Int
  color            String      @default("blue")
  order            Int
  createdAt        DateTime    @default(now())
  updatedAt        DateTime
  category         String
  dependencies     String?
  effort           Decimal     @db.Decimal(10, 2)
  startBusinessDay Int
  projects         projects    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  resources        resources[]

  @@index([order])
  @@index([projectId])
}

model projects {
  id                 String              @id
  name               String
  description        String?
  status             ProjectStatus       @default(DRAFT)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime
  clientName         String?
  complexity         String?
  duration           Int?
  employees          Int?
  endDate            DateTime?
  industry           String?
  integrationPosture String?
  legalEntities      Int?
  moduleCombo        String?
  ownerId            String
  rateRegion         String?
  region             String?
  revenue            Decimal?            @db.Decimal(15, 2)
  ssoMode            String?
  startDate          DateTime?
  totalCost          Decimal?            @db.Decimal(15, 2)
  totalEffort        Decimal?            @db.Decimal(10, 2)
  chips              chips[]
  comments           comments[]
  form_items         form_items[]
  integration_items  integration_items[]
  phases             phases[]
  users              users               @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  resources          resources[]
  ricefw_items       ricefw_items[]
  shares             shares[]
  snapshots          snapshots[]
  dashboardSnapshots DashboardSnapshot[]
  dashboardScenarios DashboardScenario[]
  dashboardComments  DashboardComment[]
  dashboardExports   DashboardExport[]

  @@index([createdAt])
  @@index([ownerId])
  @@index([status])
}

model push_subscriptions {
  id           String   @id
  email        String   @unique
  subscription Json
  createdAt    DateTime @default(now())
  updatedAt    DateTime

  @@index([email])
}

model resources {
  id         String   @id
  projectId  String
  phaseId    String?
  name       String
  role       String
  allocation Int
  createdAt  DateTime @default(now())
  hourlyRate Decimal  @db.Decimal(10, 2)
  region     String
  phases     phases?  @relation(fields: [phaseId], references: [id])
  projects   projects @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([phaseId])
  @@index([projectId])
}

model ricefw_items {
  id            String   @id
  projectId     String
  type          String
  name          String
  description   String?
  complexity    String
  count         Int
  effortPerItem Decimal  @db.Decimal(10, 2)
  totalEffort   Decimal  @db.Decimal(10, 2)
  phase         String
  createdAt     DateTime @default(now())
  updatedAt     DateTime
  projects      projects @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([projectId, type])
}

model sessions {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  deviceInfo   Json?
  ipAddress    String?
  lastActivity DateTime @default(now())

  // Enhanced session tracking
  deviceFingerprint String?
  userAgent         String?
  country           String?
  city              String?
  createdAt         DateTime  @default(now())
  revokedAt         DateTime?
  revokedReason     String? // 'user_action', 'concurrent_limit', 'security_breach', 'expired'

  users users @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([lastActivity])
  @@index([deviceFingerprint])
  @@index([revokedAt])
}

model shares {
  id           String    @id
  projectId    String
  token        String    @unique
  expiresAt    DateTime?
  viewCount    Int       @default(0)
  lastViewedAt DateTime?
  createdAt    DateTime  @default(now())
  projects     projects  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([token])
}

model snapshots {
  id        String   @id
  projectId String
  data      Json
  createdAt DateTime @default(now())
  createdBy String
  label     String?
  version   Int
  projects  projects @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, version])
  @@index([projectId])
}

model users {
  id                 String    @id
  email              String    @unique
  name               String?
  createdAt          DateTime  @default(now())
  emailVerified      DateTime?
  image              String?
  role               Role      @default(USER)
  updatedAt          DateTime
  accessExpiresAt    DateTime  @default(now())
  exception          Boolean   @default(false)
  firstLoginAt       DateTime?
  lastLoginAt        DateTime?
  lastTimelineAt     DateTime?
  timelinesGenerated Int       @default(0)
  lastSeenAt         DateTime?

  // Password & Security Fields
  passwordHash      String?
  passwordChangedAt DateTime?
  passwordExpiresAt DateTime?
  passwordHistory   String[] // Last 5 hashed passwords

  // TOTP Fields
  totpSecret    String? // Encrypted TOTP secret
  totpEnabledAt DateTime?

  // Session Management
  maxConcurrentSessions Int @default(1)

  // Account Security
  accountLockedAt     DateTime?
  accountLockedReason String?
  failedLoginAttempts Int       @default(0)
  lastFailedLoginAt   DateTime?

  // Pending Email Change
  pendingEmail          String?
  pendingEmailToken     String?
  pendingEmailExpiresAt DateTime?

  // Relationships
  AuditEvent       AuditEvent[]
  Authenticator    Authenticator[]
  accounts         accounts[]
  audit_logs       audit_logs[]
  comments         comments[]
  projects         projects[]
  sessions         sessions[]
  ganttProjects    GanttProject[]
  trustedDevices   TrustedDevice[]
  loginHistory     LoginHistory[]
  recoveryCodes      RecoveryCode[]
  securityActions    SecurityAction[]
  recoveryRequests   AccountRecoveryRequest[]
  dashboardSnapshots DashboardSnapshot[]
  dashboardScenarios DashboardScenario[]
  dashboardComments  DashboardComment[]
  dashboardSettings  DashboardSettings?
  dashboardExports   DashboardExport[]

  @@index([email])
  @@index([lastSeenAt])
  @@index([accountLockedAt])
  @@index([passwordExpiresAt])
}

model verification_tokens {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  SHARE
  EXPORT
  APPROVE
  ARCHIVE
}

enum ChipType {
  COUNTRY
  EMPLOYEES
  REVENUE
  INDUSTRY
  MODULES
  TIMELINE
  INTEGRATION
  COMPLIANCE
  LEGAL_ENTITIES
  SSO
  BANKING
  EXISTING_SYSTEM
  LOCATIONS
  USERS
  DATA_VOLUME
  CURRENCIES
  LANGUAGES
}

enum ProjectStatus {
  DRAFT
  IN_REVIEW
  APPROVED
  ARCHIVED
}

enum Role {
  USER
  MANAGER
  ADMIN
}

// ============================================
// SAP Cockpit - Phase 1: L3-Based Estimator Models
// ============================================

/// Organization for multi-tenancy support
model Organization {
  id              String           @id @default(cuid())
  name            String
  settings        Json // { defaultRateCard, holidayCalendars, allowTierD }
  members         TeamMember[]
  scenarios       Scenario[]
  savedSelections SavedSelection[]
  rateCards       RateCard[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([name])
}

/// Team member with role-based access control
model TeamMember {
  id             String       @id @default(cuid())
  userId         String
  organizationId String
  role           UserRole     @default(VIEWER)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt      DateTime     @default(now())

  @@unique([userId, organizationId])
  @@index([organizationId])
  @@index([userId])
}

enum UserRole {
  ADMIN
  OWNER
  EDITOR
  VIEWER
}

/// Line of Business (12 LOBs)
model Lob {
  id                  String        @id @default(cuid())
  lobName             String        @unique
  l3Count             Int
  releaseTag          String
  navigatorSectionUrl String
  l3ScopeItems        L3ScopeItem[]
  createdAt           DateTime      @default(now())

  @@index([lobName])
}

/// L3 Scope Item (293 items from SAP Process Navigator)
model L3ScopeItem {
  id                  String              @id @default(cuid())
  lobId               String
  lob                 Lob                 @relation(fields: [lobId], references: [id], onDelete: Cascade)
  module              String?
  l3Code              String              @unique
  l3Name              String
  processNavigatorUrl String
  formerCode          String?
  releaseTag          String
  complexityMetrics   ComplexityMetrics?
  integrationDetails  IntegrationDetails?
  createdAt           DateTime            @default(now())

  @@index([lobId])
  @@index([l3Code])
  @@index([module])
}

/// Complexity metrics for each L3 item
model ComplexityMetrics {
  id                 String      @id @default(cuid())
  l3Id               String      @unique
  l3ScopeItem        L3ScopeItem @relation(fields: [l3Id], references: [id], onDelete: Cascade)
  defaultTier        String // A, B, C, D
  coefficient        Float? // NULL for Tier D
  tierRationale      String
  crossModuleTouches String? // e.g., "FIâ†”CO"
  localizationFlag   Boolean     @default(false)
  extensionRisk      String // Low, Med, High
  createdAt          DateTime    @default(now())

  @@index([defaultTier])
  @@index([extensionRisk])
}

/// Integration details for each L3 item
model IntegrationDetails {
  id                          String      @id @default(cuid())
  l3Id                        String      @unique
  l3ScopeItem                 L3ScopeItem @relation(fields: [l3Id], references: [id], onDelete: Cascade)
  integrationPackageAvailable String // Yes, No, NA
  testScriptExists            Boolean     @default(true)
  createdAt                   DateTime    @default(now())
}

/// Saved L3 selection bundles for reuse
model SavedSelection {
  id             String       @id @default(cuid())
  name           String
  description    String?
  l3ItemIds      String[] // Array of L3 codes
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy      String
  isPublic       Boolean      @default(false)
  usageCount     Int          @default(0)
  tags           String[]
  createdAt      DateTime     @default(now())

  @@index([organizationId])
  @@index([createdBy])
  @@index([isPublic])
}

/// Rate card for resource costing
model RateCard {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name           String
  country        String
  currency       String
  rates          Json // { role: dailyRate }
  effectiveFrom  DateTime
  effectiveTo    DateTime?
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())

  @@index([organizationId, isActive])
  @@index([country])
}

/// Scenario (saved estimate with results)
model Scenario {
  id             String            @id @default(cuid())
  userId         String
  organizationId String?
  organization   Organization?     @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  name           String
  inputs         Json // EstimatorInputs
  totalMD        Float
  durationMonths Float
  pmoMD          Float
  phases         Json // PhaseBreakdown[]
  startDate      DateTime?
  resources      Json? // ResourceAllocation[]
  versions       ScenarioVersion[]
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  @@index([userId])
  @@index([organizationId])
  @@index([createdAt])
}

/// Scenario version history for audit trail
model ScenarioVersion {
  id            String   @id @default(cuid())
  scenarioId    String
  scenario      Scenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  versionNumber Int
  label         String?
  snapshot      Json // Complete scenario state
  changes       Json? // Diff from previous version
  changeReason  String?
  createdBy     String
  createdAt     DateTime @default(now())

  @@unique([scenarioId, versionNumber])
  @@index([scenarioId])
  @@index([createdAt])
}

// ============================================
// Gantt Tool - Database Models
// ============================================

/// Gantt Project - Main project container
model GanttProject {
  id          String   @id @default(cuid())
  userId      String // Owner of the project
  name        String
  description String?  @db.Text
  startDate   DateTime @db.Date

  // View settings stored as JSON for flexibility
  viewSettings Json // GanttViewSettings type

  // Relationships
  phases     GanttPhase[]
  milestones GanttMilestone[]
  holidays   GanttHoliday[]
  resources  GanttResource[]

  // Sharing and collaboration
  shares GanttProjectShare[]

  // Budget (stored as JSON for flexibility)
  budget Json? // ProjectBudget type

  // Organization Chart (stored as JSON for flexibility)
  orgChart Json? // Organization chart structure with levels and groups

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Soft delete support
  deletedAt DateTime?

  // User relationship
  user users @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([updatedAt])
  @@index([deletedAt])
}

/// Gantt Phase - Major project phases
model GanttPhase {
  id          String   @id @default(cuid())
  projectId   String
  name        String
  description String?  @db.Text
  color       String // Hex color code
  startDate   DateTime @db.Date
  endDate     DateTime @db.Date
  collapsed   Boolean  @default(false)
  order       Int      @default(0) // Display order

  // Dependencies stored as array of phase IDs
  dependencies String[] // Array of GanttPhase IDs

  // Relationships
  project                  GanttProject                   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks                    GanttTask[]
  phaseResourceAssignments GanttPhaseResourceAssignment[]

  @@index([projectId])
  @@index([order])
}

/// Gantt Task - Individual tasks within phases
model GanttTask {
  id          String   @id @default(cuid())
  phaseId     String
  name        String
  description String?  @db.Text
  startDate   DateTime @db.Date
  endDate     DateTime @db.Date
  progress    Int      @default(0) // 0-100
  assignee    String? // Legacy field, use resourceAssignments instead
  order       Int      @default(0) // Display order within phase

  // Dependencies stored as array of task IDs
  dependencies String[] // Array of GanttTask IDs

  // Task Hierarchy - Parent-child relationships (Work Breakdown Structure)
  parentTaskId String?  // ID of parent task (null for top-level tasks)
  level        Int      @default(0) // Nesting level (0 = top-level, 1 = first level subtask, etc.)
  collapsed    Boolean  @default(false) // UI state: if true, children are hidden
  isParent     Boolean  @default(false) // True if this task has child tasks

  // Relationships
  phase               GanttPhase                    @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  resourceAssignments GanttTaskResourceAssignment[]

  // Self-referential relationship for hierarchy
  parentTask GanttTask?  @relation("TaskHierarchy", fields: [parentTaskId], references: [id], onDelete: Cascade)
  childTasks GanttTask[] @relation("TaskHierarchy")

  @@index([phaseId])
  @@index([order])
  @@index([parentTaskId])
  @@index([level])
}

/// Gantt Milestone - Key project milestones
model GanttMilestone {
  id          String   @id @default(cuid())
  projectId   String
  name        String
  description String?  @db.Text
  date        DateTime @db.Date
  icon        String // Lucide icon name
  color       String // Hex color code

  // Relationships
  project GanttProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([date])
}

/// Gantt Holiday - Project holidays/non-working days
model GanttHoliday {
  id        String   @id @default(cuid())
  projectId String
  name      String
  date      DateTime @db.Date
  region    String // e.g., "US", "MY", "Global"
  type      String // "public" | "company" | "custom"

  // Relationships
  project GanttProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([date])
}

/// Gantt Resource - Team members and their roles
model GanttResource {
  id          String @id @default(cuid())
  projectId   String
  name        String // Role name (not person name)
  category    String // ResourceCategory enum value
  description String @db.Text
  designation String // ResourceDesignation enum value

  // Organization hierarchy
  managerResourceId String? // ID of manager resource
  email             String?
  department        String?
  location          String?
  projectRole       String?

  // Cost tracking
  rateType          String? // "hourly" | "daily" | "fixed"
  hourlyRate        Decimal? @db.Decimal(10, 2)
  dailyRate         Decimal? @db.Decimal(10, 2)
  currency          String? // e.g., "USD", "MYR"
  utilizationTarget Int? // 0-100

  // Metadata
  createdAt DateTime @default(now())

  // Relationships
  project          GanttProject                   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  taskAssignments  GanttTaskResourceAssignment[]
  phaseAssignments GanttPhaseResourceAssignment[]

  @@index([projectId])
  @@index([category])
}

/// Task Resource Assignment - Links resources to tasks
model GanttTaskResourceAssignment {
  id                   String   @id @default(cuid())
  taskId               String
  resourceId           String
  assignmentNotes      String   @db.Text // What they do on this task
  allocationPercentage Int // 0-100
  assignedAt           DateTime @default(now())

  // Relationships
  task     GanttTask     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  resource GanttResource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@unique([taskId, resourceId]) // Prevent duplicate assignments
  @@index([taskId])
  @@index([resourceId])
}

/// Phase Resource Assignment - Links PM resources to phases
model GanttPhaseResourceAssignment {
  id                   String   @id @default(cuid())
  phaseId              String
  resourceId           String
  assignmentNotes      String   @db.Text
  allocationPercentage Int // 0-100
  assignedAt           DateTime @default(now())

  // Relationships
  phase    GanttPhase    @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  resource GanttResource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@unique([phaseId, resourceId]) // Prevent duplicate assignments
  @@index([phaseId])
  @@index([resourceId])
}

/// Gantt Project Share - Share projects with view-only access
model GanttProjectShare {
  id           String    @id @default(cuid())
  projectId    String
  token        String    @unique // Public share token
  expiresAt    DateTime?
  viewCount    Int       @default(0)
  lastViewedAt DateTime?
  createdAt    DateTime  @default(now())
  createdBy    String // User ID who created the share

  // Relationships
  project GanttProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([token])
}

// ============================================
// Advanced Authentication & Security Models
// ============================================

/// Trusted devices for device fingerprinting
model TrustedDevice {
  id          String   @id @default(cuid())
  userId      String
  fingerprint String // Hashed device signature
  lastSeenIp  String
  lastSeenAt  DateTime @default(now())
  nickname    String? // "My MacBook", "iPhone"
  userAgent   String
  country     String?
  city        String?
  createdAt   DateTime @default(now())

  user users @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, fingerprint])
  @@index([userId])
  @@index([fingerprint])
  @@index([lastSeenAt])
}

/// Login history with IP intelligence
model LoginHistory {
  id                String   @id @default(cuid())
  userId            String
  ipAddress         String
  country           String?
  city              String?
  region            String?
  timezone          String?
  deviceId          String? // FK to TrustedDevice (optional)
  deviceFingerprint String?
  userAgent         String?
  success           Boolean
  failureReason     String? // 'invalid_password', 'invalid_totp', 'account_locked', etc.
  authMethod        String? // 'passkey', 'password_totp', 'magic_link'
  timestamp         DateTime @default(now())

  user users @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([ipAddress])
  @@index([timestamp])
  @@index([success])
  @@index([deviceFingerprint])
}

/// Recovery codes for account recovery
model RecoveryCode {
  id        String    @id @default(cuid())
  userId    String
  codeHash  String // Bcrypt hash
  usedAt    DateTime?
  usedFrom  String? // IP address where used
  createdAt DateTime  @default(now())

  user users @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([usedAt])
}

/// Security actions (e.g., "Not me" button responses)
model SecurityAction {
  id        String    @id @default(cuid())
  userId    String
  action    String // 'revoke_all', 'confirm_login', 'unlock_account'
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  ipAddress String?
  userAgent String?
  metadata  Json? // Additional context (e.g., loginId, deviceId)
  createdAt DateTime  @default(now())

  user users @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@index([usedAt])
}

/// Account recovery requests (admin-assisted)
model AccountRecoveryRequest {
  id              String    @id @default(cuid())
  userId          String
  reason          String // 'lost_totp', 'lost_all', 'lost_passkey'
  status          String    @default("pending") // 'pending', 'approved', 'rejected'
  submittedAt     DateTime  @default(now())
  approvedBy      String? // Admin user ID
  approvedAt      DateTime?
  rejectedBy      String?
  rejectedAt      DateTime?
  rejectionReason String?
  notes           String?   @db.Text

  user users @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([submittedAt])
}

/// Email delivery tracking
model EmailLog {
  id         String    @id @default(cuid())
  to         String
  subject    String
  template   String // 'new_device_login', 'password_expiry', etc.
  status     String    @default("pending") // 'pending', 'sent', 'failed', 'bounced'
  provider   String? // 'resend', 'gmail'
  error      String?   @db.Text
  metadata   Json? // Template variables, token, etc.
  sentAt     DateTime?
  failedAt   DateTime?
  retryCount Int       @default(0)
  createdAt  DateTime  @default(now())

  @@index([to])
  @@index([status])
  @@index([template])
  @@index([createdAt])
}

// ============================================================================
// Dashboard Persistence Models
// ============================================================================

/// Dashboard Snapshot - Stores saved dashboard states for later recall
model DashboardSnapshot {
  id          String   @id @default(cuid())
  projectId   String
  userId      String
  name        String
  description String?

  // Dashboard data
  costBreakdown Json    // CostBreakdown interface
  margins       Json    // MarginAnalysis interface
  revenue       Decimal @db.Decimal(12, 2)
  metrics       Json?   // Additional metrics

  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  isDefault   Boolean  @default(false)

  // Relations
  project     projects @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user        users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([projectId, userId])
  @@index([userId, createdAt])
}

/// Dashboard Scenario - For what-if analysis and scenario planning
model DashboardScenario {
  id          String   @id @default(cuid())
  projectId   String
  userId      String
  name        String
  description String?

  // Scenario data
  projectData   Json     // Modified GanttProject data
  revenue       Decimal  @db.Decimal(12, 2)
  assumptions   Json?    // Scenario assumptions/changes

  // Comparison metrics
  costDelta     Decimal? @db.Decimal(12, 2)
  marginDelta   Decimal? @db.Decimal(6, 3)
  timeDelta     Int?     // Days

  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  isBaseline  Boolean  @default(false)

  // Relations
  project     projects @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user        users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([userId, projectId])
}

/// Dashboard Comment - Collaborative comments on dashboard elements
model DashboardComment {
  id          String   @id @default(cuid())
  projectId   String
  userId      String
  elementId   String?  // Target element (e.g., "phase-123", "resource-456")
  elementType String?  // Type of element (phase, resource, metric, etc.)

  // Comment data
  content     String
  resolved    Boolean  @default(false)

  // Threading
  parentId    String?
  parent      DashboardComment?  @relation("CommentThread", fields: [parentId], references: [id], onDelete: Cascade)
  replies     DashboardComment[] @relation("CommentThread")

  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  project     projects @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user        users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([projectId, elementId])
  @@index([userId, projectId])
  @@index([parentId])
}

/// Dashboard Settings - User-specific dashboard preferences
model DashboardSettings {
  id          String   @id @default(cuid())
  userId      String   @unique

  // Preferences
  defaultView       String @default("all") // "all", "operational", "financial", "strategic"
  showChartTables   Boolean @default(false) // Show accessibility tables
  autoRefresh       Boolean @default(false)
  refreshInterval   Int @default(300000) // milliseconds

  // Rate card customization
  customRateCard    Json?   // Custom rate card by designation

  // Notification preferences
  notifyOnChange    Boolean @default(true)
  notifyOnComment   Boolean @default(true)

  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user        users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

/// Dashboard Share - Share dashboard snapshots with others
model DashboardShare {
  id          String   @id @default(cuid())
  snapshotId  String
  sharedBy    String
  sharedWith  String?  // Null for public shares
  accessLevel String   @default("view") // "view", "comment", "edit"

  // Share settings
  expiresAt   DateTime?
  password    String?  // Hashed password for protected shares
  allowDownload Boolean @default(true)

  // Analytics
  viewCount   Int      @default(0)
  lastViewed  DateTime?

  // Metadata
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([snapshotId])
  @@index([sharedBy])
  @@index([sharedWith])
}

/// Dashboard Export History - Track dashboard exports for audit purposes
model DashboardExport {
  id          String   @id @default(cuid())
  projectId   String
  userId      String
  format      String   // "pdf", "excel", "csv"

  // Export metadata
  filename    String
  fileSize    Int?     // bytes
  status      String   @default("pending") // "pending", "completed", "failed"
  errorMessage String?

  // S3/storage URL (if applicable)
  storageUrl  String?
  expiresAt   DateTime?

  // Metadata
  createdAt   DateTime @default(now())
  completedAt DateTime?

  // Relations
  project     projects @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user        users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([userId, createdAt])
  @@index([status])
}
