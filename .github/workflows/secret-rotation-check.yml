name: Secret Rotation Check

# Run weekly to check if secrets need rotation
on:
  schedule:
    # Every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual trigger

jobs:
  check-secret-rotation:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm install -g tsx
          npm ci

      - name: Check secret rotation status
        id: check
        run: |
          npx tsx scripts/rotate-secrets.ts --check > rotation-status.txt
          cat rotation-status.txt

          # Check if secrets are overdue
          if grep -q "OVERDUE" rotation-status.txt; then
            echo "status=overdue" >> $GITHUB_OUTPUT
            echo "severity=critical" >> $GITHUB_OUTPUT
          elif grep -q "NEEDS ROTATION" rotation-status.txt; then
            echo "status=warning" >> $GITHUB_OUTPUT
            echo "severity=warning" >> $GITHUB_OUTPUT
          else
            echo "status=ok" >> $GITHUB_OUTPUT
            echo "severity=info" >> $GITHUB_OUTPUT
          fi

      - name: Create Issue if Overdue
        if: steps.check.outputs.status == 'overdue'
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ðŸš¨ URGENT: Secrets Rotation Overdue';
            const body = `## Security Alert: Secrets Rotation Required

            One or more secrets are overdue for rotation according to the 90-day security policy.

            ### Action Required
            1. Review the rotation status below
            2. Run the rotation script: \`npx tsx scripts/rotate-secrets.ts --rotate\`
            3. Update secrets in all environments (dev, staging, production)
            4. Verify application functionality after rotation
            5. Close this issue once complete

            ### Rotation Status
            \`\`\`
            ${require('fs').readFileSync('rotation-status.txt', 'utf8')}
            \`\`\`

            ### References
            - [Secret Rotation Documentation](../docs/SECRET_ROTATION_GUIDE.md)
            - [Security Policy](../docs/SECURITY_POLICY.md)

            ---
            *This issue was automatically created by the secret rotation check workflow.*
            `;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,secrets-rotation'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['security', 'secrets-rotation', 'urgent']
              });
              console.log('Created new issue for overdue secret rotation');
            } else {
              console.log('Issue already exists for secret rotation');
            }

      - name: Post to Slack (if configured)
        if: steps.check.outputs.status == 'overdue'
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
              -H 'Content-Type: application/json' \
              -d '{
                "text": "ðŸš¨ *URGENT: Secrets Rotation Overdue*",
                "blocks": [
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "One or more secrets are overdue for rotation. Please rotate immediately.\n\nRun: `npx tsx scripts/rotate-secrets.ts --rotate`"
                    }
                  }
                ]
              }'
          else
            echo "Slack webhook not configured, skipping notification"
          fi

      - name: Upload rotation status
        uses: actions/upload-artifact@v4
        with:
          name: secret-rotation-status
          path: rotation-status.txt
          retention-days: 30

      - name: Summary
        run: |
          echo "## Secret Rotation Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ steps.check.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Severity**: ${{ steps.check.outputs.severity }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Full Report" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat rotation-status.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
